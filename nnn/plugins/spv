#!/bin/sh
# Simple PreView 
PREVIEWPID='/tmp/nnn_preview.pid'
FIFOPID='/tmp/nnn_fifo.pid'

pidkill() { [ -f "$1" ] && kill "$(cat "$1")" >/dev/null 2>&1; }
preview() {
    clear
    ext=$(echo -n "${1##*.}" | tr '[:upper:]' '[:lower:]')
    case "$ext" in
        json) jq . "$1" | bat -l json & ;;
        gz) gunzip -l "$1" | bat -l ls & ;;
        7z|a|ace|alz|arc|arj|bz|cab|cpio|deb|jar|lha|lz|lzh|lzma|lzo\
        |rar|rpm|rz|t7z|tar|tbz|tbz2|tgz|tlz|txz|tZ|tzo|war|xpi|xz|Z)
            atool -l "$1" | bat -l ls & ;;
        *) false ;;
    esac && return

    mime=$(file -Lbi -- "$1" | cut -d';' -f1)
    case "$mime" in
        text/*) bat "$1" & ;;
        */x-bittorrent) aria2c -S "$1" | bat & ;;
        *) false ;;
    esac && return

    if [ -d "$1" ];then
        tree -C -L 1 "$1" | bat &
    else
        # mediainfo "$1"
        file -b -- "$1"
    fi
}
preview_fifo() {
    while read -r sel;do
        pidkill "$PREVIEWPID"
        [ "$sel" = "close" ] && break
        [ -n "$sel" ] && preview "$sel"
        echo "$!" > "$PREVIEWPID"
    done < "$NNN_FIFO"
    pkill -P "$$"
}

if [ "$PREVIEW_MODE" ];then
    preview "$1"
    preview_fifo & 
    echo "$!" > "$FIFOPID"
    trap 'rm "$PREVIEWPID" "$FIFOPID" 2>/dev/null' EXIT INT HUP
    wait "$!" 
else
    if pidkill "$FIFOPID" ;then
        pidkill "$PREVIEWPID"
    else
        tmux split-window -h -d -l '55%' \
            -e "FIFOPID=$FIFOPID" -e "PREVIEWPID=$PREVIEWPID" \
            -e "PREVIEW_MODE=1" "$0" "$1" &
    fi
fi

exit 0
